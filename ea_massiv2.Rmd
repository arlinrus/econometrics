---
title: "Анализ социального, экологического и управленческих секторов"
author: "Астапенкова, Сорокина, Умыскова, Палакян, Осипова, Казначеев."
#date: 
output: html_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r}
library(readxl)
library(lubridate)
library(scales)
#install.packages("readr")
library(dplyr)
library(readr)
#install.packages('janitor')
library(janitor)
library(tidyverse)
library(forcats)
library(tidyr)
library(ggplot2)


```

## Обрабатываем массив

### Краткое описание столбцов в файле EA.xlsx при помощи ИИ:

A: Company Common Name — название компании.

B: Country of Headquarters — страна расположения штаб-квартиры.

C: GICS Industry Name — отрасль по классификации GICS.

D: Year — год отчётности.

E: ESG Score — общий ESG-рейтинг (Environmental, Social, Governance).

F: E Score — экологическая составляющая ESG.

G: S Score — социальная составляющая ESG.

H: G Score — управленческая составляющая ESG.

I: MC — рыночная капитализация (Market Cap).

J: TA — общие активы (Total Assets).

K: ROA — рентабельность активов (Return on Assets).

L: Debt — долг.

M: PP&E — основные средства (Property, Plant & Equipment).

N: CapEx — капитальные затраты (Capital Expenditures).

O: Revenue — выручка.

P: Cash — денежные средства.

Q: EBIT — прибыль до вычета процентов и налогов.

R: Tobin Q — коэффициент Тобина (отношение рыночной стоимости к стоимости активов).

S: Leverage — финансовый леверидж (отношение долга к активам).

T: OP_margin — операционная маржа.

U–AC (ln\_...) — натуральные логарифмы соответствующих финансовых показателей (например, ln_MC — логарифм рыночной капитализации).

AD: Industry — бинарный показатель отраслевой принадлежности (0 или 1).

### Существуют ли пропуски...? Как мы можем обработать массив, сейчас мы это и узнаем!

#### Посмотрим на данные до преобразования:

```{r}
data_ea <- read_excel("EA.xlsx")
```

Заметим, что большинство столбцов имеют пробелы между словами, а также существуют пробелы в целом в строках.
Поэтому преобразуем имена столбцов в чистый формат:

```{r}
data_ea <- read_excel("EA.xlsx") |> clean_names()
head(data_ea)
```

#### Посмотрим на типы переменных, а также пропущенные значения

```{r}
library(visdat)
vis_dat(data_ea)
```

Заметим, что numeric преобладают над character.

```{r}
vis_miss(data_ea)
```

Пропущенных данных в массиве нету.

Изобразим по переменных пропупущенные значения ещё раз, чтобы было нагляднее видно, что по всем данным Na отсутствует.

```{r}
colSums(is.na(data_ea))
```

Заметим, что пропусков в данных нету в обоих графиках.

Теперь обработаем типы переменных и сам массив.
Видим 3 типа chr и 31 num.

```{r}
str(data_ea)
```

```{r}
#install.packages("stringi")
library(stringi)

clean <- function(x){
  if (!is.character(x) && !is.factor(x)) return(x)
  x <- as.character(x)
  x <- ifelse(is.na(x), NA_character_, x)
  x <- str_squish(x)
  str_to_lower(x)
}

data_ea <- data_ea |> mutate(across(where(~ is.character(.) || is.factor(.)), clean))

```

Создадим функцию, в которой обозначим, что если переменные не равны chr и factor, то возвращаем преобразованные значения, которые мы задаем в переменную $x$.
Таким образом, проверяем, является ли значение $x$ пропущенным (NA), и если да, то возвращает строку NA_character\_.
В противном случае, она возвращает исходное значение $x$.

Таким образом мы привели переменные к нижнему регистру и убрали пробелы вначале и вконце слова.

```{r}
summary(data_ea)
glimpse(data_ea)
sum(is.na(data_ea))
#spec(data_ea)
#sapply(data_ea, class)
str(data_ea)
```

```{r}
data_ea <- data_ea |>
  mutate(
    year = as.integer(year),
    industry = as.integer(industry)
  )
```

Поменяли тип переменных $даты$ и $industry$ на $integer$, так как $double$ не соответствует для года и бинарному показателю отраслевой принадлежности, потому что является натуральным числом.

#### Провериим повторяющиеся значения в данных:

```{r}
duplicates <- data_ea |>
  group_by(country_of_headquarters, gics_industry_name, year,esg_score,e_score,s_score,g_score, mc, ta, roa, debt, pp_e, cap_ex, revenue, cash, ebit, tobin_q, leverage, op_margin, ln_mc, ln_debt, ln_pp_e, ln_cap_ex, ln_rev, ln_cash, ln_tq, ln_leverage, ln_op_margin, ln_esg, ln_e, ln_s, ln_g, industry) |>
  filter(n() > 1)

# Проверка количества повторов
data_ea |> 
  group_by(country_of_headquarters, gics_industry_name, year,esg_score,e_score,s_score,g_score, mc, ta, roa, debt, pp_e, cap_ex, revenue, cash, ebit, tobin_q, leverage, op_margin, ln_mc, ln_debt, ln_pp_e, ln_cap_ex, ln_rev, ln_cash, ln_tq, ln_leverage, ln_op_margin, ln_esg, ln_e, ln_s, ln_g, industry) |>
  summarise(count = n()) |>
  filter(count > 1)
```

*Повторяющихся* значений в данных нету.

#### Посмотрим выбросы для всех финансовых показателей:

```{r}
financial_cols <- c("ln_mc", "ln_ta", "ln_roa", "ln_debt", "ln_pp_e", "ln_cap_ex",
                    "ln_revenue", "ln_cash", "ln_ebit", "ln_tobin_q",
                    "ln_leverage", "ln_op_margin")

financial_cols <- financial_cols[financial_cols %in% names(data_ea)]

df_long <- data_ea |>
  select(all_of(financial_cols)) |>
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")

ggplot(df_long, aes(x = variable, y = value)) +
  geom_boxplot(outlier.colour = "red", fill = "lightblue") +
  labs(title = "Выбросы по финансовым показателям",
       x = "Показатель", y = "Значение") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

По боксплот видно, что все финансовые показатели имеют выбросы.
В данном случае, мы *не будем* проводить их очистку, так как в масссиве предоставлены данные разных компаний с разной выручкой.
Удаление выбросов может привести к искажению представления о данных в анализе.

#### Изобразим гистаграмму распределния данных для визаульной наглядности распределения переменных:

```{r}
ggplot(df_long, aes(x=value))+
  geom_histogram(aes(y = ..density..), bins = 30, fill = "skyblue", color = "black") +
  geom_density(color = "red", linewidth = 1) +
  facet_wrap(~ variable, scales = "free") +
  theme_minimal() +
  labs(title = "Распределения логарифмированных показателей",
       x = "Значение", y = "Плотность")
  

```

По графику видно, что распределение у некоторых переменных равномерно, но для достоверности проведем тест.

## Статистический анализ

### Описательная статистика

#### Проверка статистических гипотез

*Гипотеза 1* H0: Все компоненты ESG (E, S, G) оказывают одинаковое влияние на ln_op_margin, либо не оказывают статистически значимого влияния.

H1: Компоненты ESG (E, S, G) оказывают статистически значимое влияние на ln_op_margin.

*Гипотеза 2* H0: Интегрированный подход к управлению основными средствами, учитывающий все ESG-факторы, приведет к повышению финансовой устойчивости компании и росту ее стоимости в долгосрочной перспективе.

H1: Игнорирование ESG-факторов при управлении основными средствами не окажет существенного негативного влияния на финансовую устойчивость и стоимость компании в долгосрочной перспективе, так как краткосрочные финансовые выгоды от экономии на ESG-мерах перевешивают долгосрочные риски.

*Гипотеза 3* H0: Средний S_score не меняется со временем (по годам).

H1: Средний S_score растет со временем (из-за глобальных трендов на sustainability).

*Гипотеза 1: Влияние E, S, G на ln_op_margin*

Обоснование: Для проверки гипотезы о влиянии нескольких независимых переменных (компонентов ln_e, ln_s, ln_g) на одну зависимую количественную переменную (ln_op_margin) был выбран метод множественной линейной регрессии (Multiple Linear Regression).

Мы будем анализировать два ключевых аспекта:

Общую значимость модели (F-statistic): Этот тест проверяет "общую" H0 (βE = βS = βG = 0), то есть гипотезу о том, что все компоненты ESG вместе не имеют статистически значимого влияния.

Индивидуальную значимость (t-statistics): Этот тест позволяет оценить, вносит ли конкретный компонент (ln_e, ln_s или ln_g) значимый вклад в объяснение ln_op_margin, при условии наличия в модели остальных факторов.

```{r}
cat("Результаты по Гипотезе 1")

# H0: Компоненты не оказывают влияния (β_E = β_S = β_G = 0)
# H1: Хотя бы один компонент оказывает влияние

model_h1 <- lm(ln_op_margin ~ ln_e + ln_s + ln_g, data = data_ea)

# Выводим F-статистику (общая значимость) и t-статистики (индивидуальные)
summary(model_h1)

# Выводы по F-statistic (внизу): если p-value < 0.05, модель в целом значима (H1).
# Выводы по Coefficients (Estimate и Pr(>|t|)):
#   - Estimate показывает направление (+/-)
#   - Pr(>|t|) < 0.05 показывает значимость отдельного фактора.
```

На основании результатов регрессионного анализа, где мы исследовали влияние компонентов ESG (ln_e, ln_s, ln_g) на операционную маржу (ln_op_margin), можно сделать следующие выводы:

**1. Общая значимость модели Проверка H0:**

Все $\beta = 0$

F-статистика: $23.5$

P-value: $6.127\text{e-}15$ (очень мало)

Вывод: Поскольку $p$-value для $F$-статистики ($6.127\text{e-}15$) значительно меньше стандартного уровня значимости $\alpha = 0.05$, нулевая гипотеза (H0) о том, что все компоненты ESG не оказывают статистически значимого влияния на $\text{ln_op_margin}$, отвергается.
Мы с уверенностью принимаем альтернативную гипотезу (H1): по крайней мере один из компонентов ESG оказывает статистически значимое влияние на операционную маржу.

**2. Индивидуальное влияние компонентов (t-тесты)**

Экологический компонент ($\text{ln_e}$): коэффициент $\beta_E = -0.1556$ является статистически значимым ($p < 0.001$).
Знак коэффициента отрицательный.
Это означает, что чем выше экологический рейтинг компании, тем ниже ее операционная маржа, при прочих равных условиях.
Это может отражать тот факт, что инвестиции в экологически чистые технологии и соблюдение строгих экологических норм приводят к росту операционных расходов в краткосрочной/среднесрочной перспективе.

Социальный компонент ($\text{ln_s}$): коэффициент $\beta_S = -0.0042$ статистически не значим ($p = 0.8831$).
Это означает, что не найдено свидетельств значимого линейного влияния социального рейтинга компании на ее операционную маржу.

Управленческий компонент ($\text{ln_g}$): коэффициент $\beta_G = 0.0561$ статистически не значим на стандартном уровне $0.05$, хотя и находится на границе значимости ($p = 0.0976$).
Знак коэффициента положительный, что указывает на потенциально положительную связь между качеством управления и операционной маржой.

**3. Качество модели**

$R^2$ (Multiple R-squared): $0.03542$

Вывод: Значение $R^2$ крайне низкое ($3.54\%$).
Это означает, что хотя компоненты ESG (в частности, $\text{ln_e}$) оказывают статистически значимое влияние на операционную маржу, эта модель объясняет лишь очень малую долю общей вариации операционной маржи.
Большая часть вариации обусловлена другими факторами (например, отраслевой принадлежностью, макроэкономикой, спецификой компании), которые не включены в эту простую модель.

Гипотеза H1 подтверждается: компоненты ESG оказывают статистически значимое влияние на $\text{ln_op_margin}$.
Однако, это влияние практически полностью обусловлено отрицательным эффектом экологического компонента ($\text{ln_e}$), в то время как социальный и управленческий компоненты не показывают значимого влияния в рамках данной модели.Экономический вывод: для данной выборки наблюдается эффект «платы за экологичность» (trade-off), где повышение экологических стандартов ассоциируется с небольшим, но статистически значимым снижением операционной рентабельности.

*Гипотеза 2: Интегрированный подход (ESG PP&E)*

Обоснование: данные имеют панельную структуру (компании наблюдаются в течение нескольких лет).
Мы выбрали панельную регрессию с фиксированными эффектами (Fixed Effects Panel Regression), поскольку этот метод позволяет контролировать все ненаблюдаемые, неизменные во времени характеристики компаний (например, корпоративную культуру, отраслевую принадлежность), которые могут влиять как на стоимость компании, так и на ее ESG-показатели.

Для проверки гипотезы об интегрированном подходе мы ввели в модель переменную взаимодействия (ln_esg \* ln_pp_e).
Статистическая гипотеза H1 (β_interaction \> 0) будет поддержана, если коэффициент при этой переменной (ln_esg:ln_pp_e) окажется положительным и статистически значимым.

```{r}
cat("Результаты по Гипотезе 2/")

cat("Испольхуем тест Хаусмана  для выбора между двумя статистическими моделями:")
# install.packages("plm")
# install.packages("lmtest")
library(plm)
library(lmtest)
#install.packages("lmtest")
library(zoom)

# H0: Интеграция ESG и PP&E не создает доп. стоимости (β_interaction ≤ 0)
# H1: Интеграция ESG и PP&E положительно связана со стоимостью (β_interaction > 0)

pdata <- pdata.frame(data_ea, index = c("company_common_name", "year"))

model_fe <- plm(ln_tq ~ ln_esg + ln_pp_e + ln_esg:ln_pp_e +
                 roa + leverage + ln_mc + ln_rev + ln_cap_ex,
               data = pdata, model = "within")

model_re <- plm(ln_tq ~ ln_esg + ln_pp_e + ln_esg:ln_pp_e +
                 roa + leverage + ln_mc + ln_rev + ln_cap_ex,
               data = pdata, model = "random")

phtest(model_fe, model_re)
```

Используем для фиксированных значений, то есть model_fe

Тест на гетероскедантичность:

```{r}
bptest(model_fe)
```

Так как p= 8.095e-07, значит p \< 0.05 → есть гетероскедастичность, значит используем робастые стандартные ошибки, так как ошибки прогноза в нашей модели непостоянны для разных компаний.

```{r}
summary(model_fe)
```

На основании результатов панельной регрессии с фиксированными эффектами (Within Model), где мы проверяли влияние интегрированного подхода (взаимодействие $\text{ln_esg}$ и $\text{ln_pp_e}$) на стоимость компании ($\text{ln_tq}$), можно сделать следующие выводы:

**1. Общая значимость модели и фиксированных эффектов**

$F$-статистика: $2308.68$

$P$-value: $< 2.22\text{e-}16$ (очень мало)

Вывод: Поскольку $p$-value для $F$-статистики значительно меньше $\alpha = 0.05$, модель в целом является статистически значимой.
Она объясняет вариацию стоимости компании $\text{ln_tq}$ лучше, чем модель без предикторов.
Это также подтверждает, что использование фиксированных эффектов (учет ненаблюдаемых различий между компаниями) было оправдано.

$R^2$ (Внутригрупповой): $0.93828$

Модель объясняет около $93.8%$ вариации $\text{ln_tq}$ внутри компаний с течением времени.

**2. Проверка гипотезы о взаимодействии**

Гипотеза 2 проверялась через коэффициент взаимодействия:

H0: Интегрированный подход не приводит к росту стоимости ($\beta_{\text{взаимодействия}} \le 0$).

H1: Интегрированный подход приводит к росту стоимости ($\beta_{\text{взаимодействия}} > 0$).

Коэффициент взаимодействия $\text{ln_esg:ln_pp_e}$:

Коэффициент отрицательный ($-0.01849$).

$P$-value ($0.03055$) меньше $0.05$.

Вывод: Нулевая гипотеза отвергается.
Коэффициент взаимодействия статистически значим.
Однако его точечная оценка отрицательна, что прямо противоречит теоретическому ожиданию H1.

Мы обнаружили статистически значимые доказательства того, что интегрированный подход к управлению основными средствами и ESG приводит к снижению стоимости компании ($\text{ln_tq}$) после учета индивидуальных эффектов компаний.

**3.Влияние отдельных факторов (контрольные переменные)**

$\text{ln_esg}$: коэффициент не значим ($p = 0.4302$).
Это означает, что сам по себе общий ESG-рейтинг не оказывает значимого влияния на $\text{ln_tq}$ в данной модели.

$\text{ln_pp_e}$ (Основные средства): коэффициент отрицательный ($-0.3499$) и статистически значим ($p < 0.01$).
Это указывает на то, что, при прочих равных условиях, включая уровень ESG, увеличение основных средств связано с небольшим снижением стоимости компании (измеряемой через $\text{ln_tq}$).
Это может отражать эффект "неэффективного роста" или высокую капиталоемкость, которая плохо воспринимается рынком.

Общий вывод: гипотеза H1 о том, что интегрированный подход ESG и PP&E приведет к росту стоимости, не находит подтверждения в данной модели.
Не обнаружено ни статистически значимого, ни положительного эффекта от взаимодействия ESG-факторов с основными средствами на стоимость компании.

*Гипотеза 3: Рост S-score со временем*

Обоснование: Для проверки гипотезы H1 о том, что "Средний S_score растет со временем", мы используем простую линейную регрессию (Simple Linear Regression).
В этой модели s_score выступает зависимой переменной, а year (год) — независимой.

Этот метод был выбран для количественной оценки линейного тренда.
Мы будем тестировать гипотезу о коэффициенте наклона β1 при переменной year:

H0 (статистическая): β1 = 0 (Нет линейного тренда).

H1 (статистическая): β1 \> 0 (Существует положительный линейный тренд).

```{r}
cat("Результаты по Гипотезе 3")

# H0: Средний S_score не меняется со временем (β_year = 0)
# H1: Средний S_score растет со временем (β_year > 0)

# Строим простую линейную регрессию, используя data_ea
model_h3 <- lm(s_score ~ year, data = data_ea)

# Смотрим на коэффициент при 'year'
summary(model_h3)

# Для поддержки H1 нам нужен коэффициент 'year':
# 1. Положительный (Estimate > 0)
# 2. Статистически значимый (Pr(>|t|) < 0.05)
```

1.  Проверка гипотезы о тренде

Гипотеза 3 проверялась через коэффициент наклона при переменной $\text{year}$:

H0: Средний $\text{s_score}$ не меняется со временем ($\beta_{\text{year}} = 0$).

H1: Средний $\text{s_score}$ растет со временем ($\beta_{\text{year}} > 0$).

Коэффициент при $\text{year}$

Коэффициент $\beta_{\text{year}} = 1.5258$ положительный.

$P$-value ($0.00353$) меньше стандартного уровня значимости $\alpha = 0.05$.

Вывод: Мы отвергаем нулевую гипотезу (H0) и принимаем альтернативную гипотезу (H1).
Существует статистически значимый положительный тренд в социальном рейтинге ($\text{s_score}$) с течением времени.

2.Интерпретация тренда

Направление и величина: С каждым годом социальный рейтинг компаний в среднем увеличивается на $1.53$ балла (при прочих равных условиях).
Это подтверждает тенденцию, связанную с "глобальными трендами на sustainability", где компании уделяют все больше внимания социальным аспектам (условиям труда, безопасности, разнообразию и т.д.).

Объясняющая способность ($R^2$): $R^2 = 0.004421$.
Это крайне низкий показатель ($0.44\%$).

Вывод по $R^2$: Несмотря на то, что тренд статистически значим, сам по себе год объясняет лишь минимальную часть общей вариации социального рейтинга.
Большая часть различий в $\text{s_score}$ обусловлена факторами, специфичными для компаний, отраслей или стран, а не просто линейным течением времени.

Гипотеза H1 подтверждается: средний социальный рейтинг ($\text{s_score}$) статистически значимо растет со временем.
Однако, сила этого тренда очень мала, и основная часть различий в социальном рейтинге зависит не от общего года наблюдения, а от других, неучтенных в модели факторов.


```{r}
data_ea_counts <- data_ea |> select('country_of_headquarters', 'e_score', 's_score', 'g_score')
data_ea_counts  
```

```{r}
country_counts <- data_ea_counts |>
  count(`country_of_headquarters`) |>
  arrange(desc(n))
country_counts
```

```{r}
knitr::opts_chunk$set(
      cache = FALSE)
country_data <- tibble::tribble(
  ~"Country of Headquarters", ~n,
  "China", 1093,
  "Japan", 649,
  "Korea; Republic (S. Korea)", 182
)


bp <- barplot(height = country_data$n,  
              names.arg = country_data$`Country of Headquarters`,
              main = 'Страна штаб-квартиры',
              col = c('lightblue', 'lightgreen', 'salmon'),
              xlab = "Страна",
              ylab = "Количество компаний",
              ylim = c(0, 1200), 
              axes = FALSE)

# Добавляем ось Y
axis(2, at = seq(from = 0, to = 1200, by = 300))

# Добавляем подписи значений
text(x = bp, 
     y = country_data$n + 10,  
     labels = country_data$n,
     pos = 3,  
     col = "black",
     font = 2)
```

По графику видно, что Китай преобладает над Японией и Северной Кореей.

```{r}
library(psych)
library(skimr)
library(corrplot)
library(GGally)
```

#### Общая информация о данных

```{r}
cat("Период данных:", min(data_ea$year), "-", max(data_ea$year), "\n")
cat("Общее количество наблюдений:", nrow(data_ea), "\n")
cat("Количество уникальных компаний:", length(unique(data_ea$company_common_name)), "\n")
cat("Количество стран:", length(unique(data_ea$country_of_headquarters)), "\n")
cat("Количество отраслей (GICS):", length(unique(data_ea$gics_industry_name)), "\n")
cat("Количество лет:", length(unique(data_ea$year)), "\n\n")
```

#### Распределение по странам(уникальные значения 701)

```{r}
country_dist <- data_ea |>
  distinct(company_common_name, country_of_headquarters) |>
  count(country_of_headquarters) |>
  mutate(percent = round(n/701*100, 1))
country_dist
```

Китай - 449 компаний (64.1%) Япония - 189 компаний (27%) Южная Корея - 63 компании (9%)

#### Основные показатели (усрдненные)

```{r}
company_avg <- data_ea |>
  group_by(company_common_name) |>
  summarise(
    esg = mean(esg_score),
    roa = mean(roa) * 100,
    leverage = mean(leverage) * 100,
    op_margin = mean(op_margin) * 100,
    .groups = 'drop'
  )

key_stats <- company_avg |>
  summarise(
    `ESG Score` = sprintf("%.1f (%.1f)", mean(esg), sd(esg)),
    `ROA (%)` = sprintf("%.2f (%.2f)", mean(roa), sd(roa)),
    `leverage (%)` = sprintf("%.1f (%.1f)", mean(leverage), sd(leverage)),
    `op_margin (%)` = sprintf("%.1f (%.1f)", mean(op_margin), sd(op_margin))
  )

key_stats
```

*ESG Score*: Средний уровень ESG - компании показывают умеренные результаты.
Высокая вариативность (стандартное отклонение 19.4) - огромный разброс между лидерами и аутсайдерами.
Вывод: Значительные различия в качестве ESG.

*ROA*: Экстремально высокие значения, явные выбросы.
Нереалистичные цифры, тк ROA редко превышает 20-30%.
Вывод: В данном случае подразуммевается чистка данных, но в массиве предоставлены разные компании, которые аналогично имеют разные показатели.
Следовательно,

*leverage*: Умеренная долговая нагрузка в среднем.
Компании сильно различаются по структуре капитала.
Вывод: Разные финансовые стратегии компаний.

*op_margin*: Здоровая рентабельность операционной деятельности.
Умеренная вариативность по сравнению с другими показателями.
Вывод: Стабильные операционные результаты.

#### Топ-5 отраслей

```{r}
data_ea |>
  distinct(company_common_name, gics_industry_name) |>
  count(gics_industry_name, name = "компаний") |>
  top_n(5, компаний) |>
  arrange(desc(компаний)) |> 
  print()
```

Преобладают промышленные и производственные сектора.

```{r}
year_distribution <- data_ea |>
  count(year, gics_industry_name) |>
  group_by(year) |>
  mutate(percentage = n / sum(n) * 100) |>
  slice_max(n, n = 5) |>
  arrange(year, desc(n))

year_distribution
```

Обратим внимание, что в каждом году Химическая индустрия остается на первом месте.
В 2022 году Электронное оборудование, инструменты и компоненты уступают металлам и горнодобывающей промышленности.
А потом опять преуспевают в 2023 году.

### Описателльная статистика E, S и G

```{r}
library(dplyr)
library(ggplot2)
library(psych)
library(knitr)
```

```{r}
esg_vars <- c("e_score", "s_score", "g_score")

esg_vars <- esg_vars[esg_vars %in% names(data_ea)]

# Считаем описательную статистику
esg_summary <- data_ea |>
  select(all_of(esg_vars)) |>
  psych::describe() |>
  as.data.frame() |>
  select(mean, sd, median, min, max, skew, kurtosis)

esg_summary
```

Средние значения (mean) показывают, что в целом компании демонстрируют: наивысшие результаты по Governance (G) - 51,9 балла, умеренные - по Environmental (E) - 47,3 балла, наименьшие - по Social (S) - 43,3 балла.

Это говорит нам о том, что компании чаще фокусируются на *управленческой прозрачности и корпоративных стандартах*, чем на *социальных* и *экологических инициативах*.

Стандартные отклонения (sd) достаточно велики (от 21 до 26), что указывает на значительную разницу между компаниями по каждому компоненту — ESG-практики сильно варьируются в зависимости от отрасли и страны.

Асимметрия (skew) близка к нулю для всех трёх показателей, значит, распределения почти симметричны и нет значительного перекоса в сторону очень высоких или очень низких оценок.

Эксцесс (kurtosis) отрицательный -\> распределение данных является относительно сглаженным и имеет более короткие хвосты, где меньше экстремальных значений.

### Средние ESG по годам

```{r}
esg_by_year <- data_ea |>
  group_by(year) |>
  summarise(
    ESG_mean = mean(esg_score, na.rm = TRUE),
    E_mean = mean(e_score, na.rm = TRUE),
    S_mean = mean(s_score, na.rm = TRUE),
    G_mean = mean(g_score, na.rm = TRUE)
  )

esg_by_year
```

```{r}
esg_analysis <- esg_by_year |>
  mutate(
    E_growth = (E_mean - lag(E_mean)) / lag(E_mean) * 100,
    S_growth = (S_mean - lag(S_mean)) / lag(S_mean) * 100,
    G_growth = (G_mean - lag(G_mean)) / lag(G_mean) * 100,
    ESG_growth = (ESG_mean - lag(ESG_mean)) / lag(ESG_mean) * 100
  )

esg_analysis
```

Какие выводы мы можем сдлеать на основании Экологии, социальной сфере и управления(политика?): ESG общий: Рост 6-7% (продолжение ускорения)

Environmental: Рост 8-9% (климатическая повестка)

Social: Рост 9-10% (фокус на человеческий капитал)

Governance: Стагнация или умеренный рост 1-2%

#### График динамики ESG (визуализация по среднему)

```{r}
esg_by_year_long <- esg_by_year |>
  pivot_longer(cols = -year, names_to = "component", values_to = "value")

ggplot(esg_by_year_long, aes(x = year, y = value, color = component)) +
  geom_line(size = 1) +
  geom_point() +
  theme_minimal() +
  labs(title = "Динамика ESG показателей (2020–2023)", y = "Среднее значение", x = "Год")
```

С 2020 по 2023 годы общий ESG-рейтинг компаний постепенно растёт (с 46,2 до 49,8), что отражает повышение внимания бизнеса к устойчивому развитию.

Самый резкий рост наблюдается по экологической сфере.
Компании активнее внедряют «зелёные» инициативы, сокращают выбросы, переходят на возобновляемые источники энергии и экологические стандарты производства.

Социальная сфера также усилился (с 41,2 до 46,1), что может быть связано с ростом значимости условий труда, безопасности и разнообразия персонала.

Управленческая сфера (G) остаётся стабильно высоким, без выраженного роста.

#### Разрез по отраслям

```{r}
# Средние значения по каждой отрасли
industry_esg_detail <- data_ea |>
  group_by(gics_industry_name) |>
  summarise(
    E_mean = mean(e_score, na.rm = TRUE),
    S_mean = mean(s_score, na.rm = TRUE),
    G_mean = mean(g_score, na.rm = TRUE)
  ) |>
  arrange(desc(E_mean))

# График для E
ggplot(industry_esg_detail, aes(x = reorder(gics_industry_name, E_mean), y = E_mean)) +
  geom_col(fill = "lightgreen") +
  coord_flip() +
  theme_minimal(base_size = 12) +
  labs(title = "Средние Environmental (E) Score по отраслям",
       x = "Отрасль", y = "Средний E Score")

# График для S
ggplot(industry_esg_detail, aes(x = reorder(gics_industry_name, S_mean), y = S_mean)) +
  geom_col(fill = "lightblue") +
  coord_flip() +
  theme_minimal(base_size = 12) +
  labs(title = "Средние Social (S) Score по отраслям",
       x = "Отрасль", y = "Средний S Score")

# График для G
ggplot(industry_esg_detail, aes(x = reorder(gics_industry_name, G_mean), y = G_mean)) +
  geom_col(fill = "pink") +
  coord_flip() +
  theme_minimal(base_size = 12) +
  labs(title = "Средние Governance (G) Score по отраслям",
       x = "Отрасль", y = "Средний G Score")
```

На барчарте по E-компоненту видно, что: Лидеры по экологическим инициативам - отрасли телекоммуникаций, высоких технологий и строительства.
Аутсайдеры - медиа, развлечения, ПО и биотехнологии, где экологические процессы менее выражены.

по S-компоненте: Лидерами по социальным показателям являются отрасли телекоммуникаций и здравоохранения.
В то же время, сектора биотехнологий, медиа и программного обеспечения демонстрируют наиболее низкие результаты в этой области.

по G-компоненте: Наивысшие оценки корпоративного управления также у телекоммуникаций, здравоохранения и технологического сектора.
При этом отрасль программного обеспечения и медиа снова оказывается в аутсайдерах, что указывает на системные пробелы в качестве управления компаний этого сектора.
